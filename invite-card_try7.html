<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>活動邀請卡</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <style>
    /* CSS 變數定義 */
    :root {
      --card-width: 37.5rem;
      --card-height: 25rem;
      --primary-color: #00b5d8;
      --bg-color: #eceae6;
      --border-color: #333;
      --text-shadow: 0.0625rem 0.0625rem 0.125rem #000;
      --gap-sm: 0.375rem;
      --gap-md: 0.625rem;
      --gap-lg: 1.25rem;
      --border-radius: 0.5rem;
    }

    * {
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
    }

    body {
      font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      background-color: var(--bg-color);
      margin: 0;
      min-height: 100vh;
    }

    /* 文字顏色類別 */
    .white {
      color: white;
    }
    .black {
      color: black;
    }

    /* 表單樣式 */
    .form-container {
      width: 100%;
      max-width: var(--card-width);
      margin-bottom: var(--gap-lg);
    }

    .form-group {
      width: 100%;
      margin-bottom: var(--gap-lg);
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 0.5rem;
      margin-bottom: 0.25rem;
    }

    input, textarea, select, button {
      width: 100%;
      font-size: 1rem;
      padding: 0.75rem;
      margin-top: 0.25rem;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 4rem;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    button:hover {
      background-color: #0099cc;
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    .button-row {
      margin-top: 0.75rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap-md);
    }

    /* 卡片容器 */
    .card-container {
      width: 100%;
      max-width: var(--card-width);
      aspect-ratio: 3/2; /* 維持 3:2 的比例 */
      position: relative;
      margin-top: var(--gap-lg);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .card {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: row;
      background-size: cover;
      background-position: center;
      border: 0.125rem solid var(--border-color);
      padding: clamp(0.75rem, 2vw, 1rem);
      text-shadow: var(--text-shadow);
      position: relative;
      border-radius: var(--border-radius);
    }

    .card-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      z-index: 0;
      border-radius: var(--border-radius);
    }

    /* 左側區域 */
    .left {
      width: 66.66%;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      gap: clamp(0.375rem, 1vw, var(--gap-md));
      position: relative;
      z-index: 1;
      padding-right: 1rem;
    }

    /* 右側區域 */
    .right {
      width: 33.33%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: flex-end;
      text-align: right;
      position: relative;
      z-index: 1;
      gap: var(--gap-sm);
    }

    .right > div {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: var(--gap-sm);
    }

    /* 文字大小響應式設計 */
    .event-name {
      font-size: clamp(1rem, 2.5vw, 1.5rem);
      font-weight: bold;
      line-height: 1.2;
      word-break: break-word;
    }

    .month-day {
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: bold;
      line-height: 0.9;
      word-break: break-word;
    }

    #timeLine {
      font-size: clamp(1.25rem, 3vw, 2rem);
      font-weight: bold;
      line-height: 1;
    }

    #yearLine {
      font-size: clamp(0.875rem, 1.5vw, 1rem);
    }

    /* QR碼區域 */
    .qr {
      background: white;
      padding: 0.25rem;
      width: clamp(4rem, 8vw, 6.25rem);
      height: clamp(4rem, 8vw, 6.25rem);
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qr canvas, .qr img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* 圖示標籤 */
    .icon-label {
      display: flex;
      align-items: center;
      gap: var(--gap-sm);
      font-size: clamp(0.75rem, 1.5vw, 1rem);
      line-height: 1.3;
    }

    .icon-label iconify-icon {
      font-size: clamp(1rem, 2vw, 1.25rem);
      flex-shrink: 0;
    }

    .icon-label div {
      word-break: break-word;
      overflow-wrap: break-word;
    }

    /* 描述文字 */
    .description {
      width: 100%;
      max-width: var(--card-width);
      text-align: left;
      margin-bottom: var(--gap-lg);
      line-height: 1.6;
      font-size: 0.95rem;
      color: #555;
    }

    /* 頁尾 */
    .footer {
      margin-top: 2rem;
      font-size: 0.875rem;
      text-align: center;
      color: #666;
    }

    .card-footer {
      position: absolute;
      bottom: 0.5rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: clamp(0.7rem, 1.2vw, 0.875rem);
      z-index: 1;
      white-space: nowrap;
    }

    /* 響應式設計 - 大型桌面 */
    @media screen and (min-width: 1400px) {
      .card-container {
        max-width: 45rem;
      }
      
      .event-name {
        font-size: 1.8rem;
      }
      
      .month-day {
        font-size: 4rem;
      }
      
      #timeLine {
        font-size: 2.5rem;
      }
    }

    /* 響應式設計 - 平板橫向 */
    @media screen and (max-width: 1024px) {
      :root {
        --card-width: 32rem;
        --card-height: 21.33rem;
      }
      
      body {
        padding: 0.75rem;
      }
      
      .left {
        padding-right: 0.75rem;
      }
    }

    /* 響應式設計 - 平板直向 */
    @media screen and (max-width: 768px) {
      :root {
        --card-width: 28rem;
        --card-height: 18.67rem;
      }
      
      body {
        padding: 0.5rem;
      }
      
      .button-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      .card {
        padding: 0.75rem;
      }
      
      .left {
        width: 60%;
        padding-right: 0.5rem;
      }
      
      .right {
        width: 40%;
      }
      
      .qr {
        width: clamp(3.5rem, 7vw, 5rem);
        height: clamp(3.5rem, 7vw, 5rem);
      }
    }

    /* 響應式設計 - 手機橫向 */
    @media screen and (max-width: 640px) {
      .card {
        flex-direction: column;
        text-align: left;
        gap: 0.75rem;
      }
      
      .left, .right {
        width: 100%;
        align-items: flex-start;
        text-align: left;
      }
      
      .right {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      
      .right > div {
        align-items: flex-start;
        text-align: left;
      }
      
      .right > div:last-child {
        align-items: flex-end;
        text-align: right;
      }
      
      .month-day {
        font-size: clamp(1.5rem, 4vw, 2.5rem);
      }
      
      #timeLine {
        font-size: clamp(1rem, 2.5vw, 1.5rem);
      }
      
      .qr {
        width: clamp(3rem, 6vw, 4rem);
        height: clamp(3rem, 6vw, 4rem);
      }
    }

    /* 響應式設計 - 小型手機 */
    @media screen and (max-width: 480px) {
      body {
        padding: 0.25rem;
      }
      
      .card {
        padding: 0.5rem;
        gap: 0.5rem;
      }
      
      .event-name {
        font-size: clamp(0.875rem, 3vw, 1.25rem);
      }
      
      .month-day {
        font-size: clamp(1.25rem, 5vw, 2rem);
      }
      
      #timeLine {
        font-size: clamp(0.875rem, 3vw, 1.25rem);
      }
      
      .icon-label {
        font-size: clamp(0.7rem, 2.5vw, 0.875rem);
      }
      
      .icon-label iconify-icon {
        font-size: clamp(0.875rem, 2.5vw, 1rem);
      }
      
      .card-footer {
        font-size: 0.625rem;
        bottom: 0.25rem;
      }
    }

    /* 高度受限的設備適配 */
    @media screen and (max-height: 600px) and (orientation: landscape) {
      body {
        padding: 0.5rem;
      }
      
      .form-container, .description {
        margin-bottom: 0.75rem;
      }
      
      .card-container {
        margin-top: 0.75rem;
      }
      
      .footer {
        margin-top: 1rem;
      }
    }

    /* 印刷樣式 */
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .form-container, .description, .footer {
        display: none;
      }
      
      .card-container {
        max-width: none;
        width: 6in;
        height: 4in;
        margin: 0;
        box-shadow: none;
      }
      
      .card {
        border: 1px solid #000;
      }
      
      .card-footer {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h2>活動卡片資訊輸入</h2>
  <div class="description">
    產生一張活動邀請卡，營造每個美好的明天！請依欄位填入文字及數字，選擇符合圖片上傳，產生卡片可供4×6吋列印。QR碼可直接導向Google Map開啟地圖位置。
  </div>
  
  <div class="form-container">
    <div class="form-group">
      <input id="name" type="text" placeholder="活動名稱" />
      <textarea id="description" placeholder="說明"></textarea>
      <input id="address" type="text" placeholder="地址" />
      <input id="date" type="date" />
      <input id="time" type="time" />
      <input id="host" type="text" placeholder="主辦單位" />
      <input id="contact" type="tel" placeholder="聯絡方式" />
      <label>上傳背景圖片：</label>
      <input type="file" id="bgImage" accept="image/*" />
      <label>文字顏色：</label>
      <select id="textColor">
        <option value="white">白色</option>
        <option value="black">黑色</option>
      </select>
      <div class="button-row">
        <button onclick="updateCard()">產生卡片</button>
        <button onclick="downloadImage()">下載卡片</button>
      </div>
    </div>
  </div>

  <div class="card-container" id="cardWrapper">
    <div class="card white" id="card">
      <img id="cardBg" class="card-bg" alt="背景圖片" />
      <div class="left">
        <div class="event-name" id="cardName">活動名稱</div>
        <div class="icon-label">
          <iconify-icon icon="material-symbols:tooltip-2"></iconify-icon>
          <div id="cardDescription">活動說明</div>
        </div>
        <div class="icon-label">
          <iconify-icon icon="material-symbols:person"></iconify-icon>
          <div id="cardHost">主辦單位</div>
        </div>
        <div class="icon-label">
          <iconify-icon icon="material-symbols:phone-in-talk"></iconify-icon>
          <div id="cardContact">聯絡方式</div>
        </div>
      </div>
      <div class="right">
        <div>
          <div class="icon-label">
            <iconify-icon icon="material-symbols:location-on"></iconify-icon>
            <div id="cardAddress">地址</div>
          </div>
          <div id="qrCodeContainer" class="qr"></div>
        </div>
        <div>
          <div class="icon-label">
            <iconify-icon icon="material-symbols:calendar-month"></iconify-icon>
            <div id="yearLine">2025</div>
          </div>
          <div class="month-day" id="monthDayLine">05/24</div>
          <div class="icon-label">
            <iconify-icon icon="material-symbols:schedule-rounded"></iconify-icon>
            <div id="timeLine">18:00</div>
          </div>
        </div>
      </div>
      <div class="card-footer">© 2025 MZW</div>
    </div>
  </div>

  <div class="footer">歡迎轉貼試用，網頁測試中 | © 2025 MZW</div>

  <script>
    let qrCodeInstance = null;

    async function updateCard() {
      const name = document.getElementById("name").value || "活動名稱";
      const desc = document.getElementById("description").value || "活動說明";
      const addr = document.getElementById("address").value || "地址";
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value || "18:00";
      const host = document.getElementById("host").value || "主辦單位";
      const contact = document.getElementById("contact").value || "聯絡方式";
      const textColor = document.getElementById("textColor").value;

      console.log('Updating card with data:', { name, desc, addr, date, time, host, contact, textColor });

      // 更新卡片內容
      document.getElementById("cardName").textContent = name;
      document.getElementById("cardDescription").textContent = desc;
      document.getElementById("cardAddress").textContent = addr;
      document.getElementById("cardHost").textContent = host;
      document.getElementById("cardContact").textContent = contact;
      document.getElementById("timeLine").textContent = time;

      // 處理日期格式
      if (date) {
        const [y, m, d] = date.split("-");
        document.getElementById("yearLine").textContent = y;
        document.getElementById("monthDayLine").textContent = `${parseInt(m)}/${parseInt(d)}`;
      } else {
        document.getElementById("yearLine").textContent = "2025";
        document.getElementById("monthDayLine").textContent = "05/24";
      }

      // 更新文字顏色
      const card = document.getElementById("card");
      card.className = `card ${textColor}`;

      // 強制設置文字顏色樣式，確保在截圖時可見
      const textElements = card.querySelectorAll('.event-name, .icon-label div, .month-day, #timeLine, #yearLine, .card-footer');
      textElements.forEach(el => {
        el.style.color = textColor === 'black' ? '#000000' : '#ffffff';
      });

      // 更新圖示顏色
      document.querySelectorAll('iconify-icon').forEach(icon => {
        icon.style.color = textColor === 'black' ? '#000000' : '#ffffff';
      });

      // 處理背景圖片
      const bgInput = document.getElementById("bgImage");
      const cardBg = document.getElementById("cardBg");
      
      if (bgInput.files && bgInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const imageUrl = e.target.result;
          console.log('Setting background image');
          
          // 同時設置背景圖片和img元素
          card.style.backgroundImage = `url('${imageUrl}')`;
          card.style.backgroundColor = 'transparent';
          cardBg.src = imageUrl;
          cardBg.style.display = 'block';
        };
        reader.onerror = function() {
          console.error('File reading failed');
        };
        reader.readAsDataURL(bgInput.files[0]);
      } else {
        card.style.backgroundImage = '';
        card.style.backgroundColor = '#f0f0f0';
        cardBg.src = '';
        cardBg.style.display = 'none';
      }

      // 等待一下再生成 QR 碼，確保其他內容已更新
      setTimeout(() => {
        generateQRCode(addr);
      }, 100);
    }

    function generateQRCode(addr) {
      const mapURL = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
      const qrCodeContainer = document.getElementById("qrCodeContainer");

      // 清除舊的 QR 碼
      if (qrCodeInstance) {
        qrCodeContainer.innerHTML = '';
        qrCodeInstance = null;
      }

      // 生成新的 QR 碼
      if (addr && addr !== "地址") {
        try {
          console.log('Generating QR code for:', mapURL);
          qrCodeInstance = new QRCode(qrCodeContainer, {
            text: mapURL,
            width: 100,
            height: 100,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
        } catch (error) {
          console.error('QR Code generation failed:', error);
          qrCodeContainer.innerHTML = '<div style="font-size: 0.7rem; text-align: center; color: #666; background: white; padding: 0.5rem;">QR碼</div>';
        }
      } else {
        qrCodeContainer.innerHTML = '<div style="font-size: 0.7rem; text-align: center; color: #666; background: white; padding: 0.5rem;">QR碼</div>';
      }
    }

    async function downloadImage() {
      const cardWrapper = document.getElementById("cardWrapper");
      const card = document.getElementById("card");
      
      if (!card) {
        alert('卡片未找到，請先產生卡片');
        return;
      }

      // 顯示載入提示
      const button = event?.target || document.querySelector('button[onclick="downloadImage()"]');
      const originalText = button?.textContent || '下載卡片';
      if (button) {
        button.textContent = '生成中...';
        button.disabled = true;
      }

      try {
        // 確保所有內容都已載入
        await ensureContentLoaded();
        
        // 暫時移除一些可能干擾渲染的樣式
        const cardBg = document.getElementById("cardBg");
        const originalBgDisplay = cardBg.style.display;
        
        // 如果有背景圖片但沒有正確顯示，嘗試修正
        if (cardBg.src && !cardBg.complete) {
          await waitForImageLoad(cardBg);
        }

        const originalWidth = cardWrapper.offsetWidth;
        const originalHeight = cardWrapper.offsetHeight;

        // 高解析度設定 (4×6吋 at 300 DPI)
        const desiredWidth = 1800; // 6吋 × 300 DPI
        const desiredHeight = 1200; // 4吋 × 300 DPI
        const scaleFactor = Math.min(desiredWidth / originalWidth, desiredHeight / originalHeight);

        console.log('Capturing card:', {
          originalWidth,
          originalHeight,
          scaleFactor,
          hasBackground: !!cardBg.src
        });

        const canvas = await html2canvas(card, {
          width: originalWidth,
          height: originalHeight,
          scale: scaleFactor,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          logging: true, // 啟用日誌以便調試
          letterRendering: true,
          foreignObjectRendering: false, // 關閉可能有問題的外部對象渲染
          imageTimeout: 15000,
          removeContainer: false,
          async: true,
          // 確保字體正確渲染
          onclone: function(clonedDoc) {
            // 確保克隆的文檔中所有文字都可見
            const clonedCard = clonedDoc.querySelector('#card');
            if (clonedCard) {
              // 強制設置文字顏色以確保可見性
              const textElements = clonedCard.querySelectorAll('*');
              textElements.forEach(el => {
                const computedStyle = window.getComputedStyle(el);
                if (computedStyle.color) {
                  el.style.color = computedStyle.color;
                }
              });
            }
          }
        });

        // 檢查 canvas 是否有內容
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const hasContent = imageData.data.some((pixel, index) => {
          // 檢查非透明像素（alpha通道）
          return index % 4 === 3 && pixel > 0;
        });

        if (!hasContent) {
          throw new Error('生成的圖片沒有內容');
        }

        // 下載圖片
        const link = document.createElement("a");
        const now = new Date();
        const timestamp = now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0');
        
        link.download = `invitation-card_${timestamp}.png`;
        link.href = canvas.toDataURL("image/png", 1.0);
        
        // 確保下載鏈接正確
        if (!link.href || link.href === 'data:,') {
          throw new Error('圖片數據生成失敗');
        }
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        console.log('Download successful');

      } catch (error) {
        console.error('Download failed:', error);
        alert(`下載失敗: ${error.message}\n請確保：\n1. 已填入卡片內容\n2. 背景圖片已正確載入\n3. 瀏覽器支援該功能`);
      } finally {
        // 恢復按鈕狀態
        if (button) {
          button.textContent = originalText;
          button.disabled = false;
        }
      }
    }

    // 輔助函數：等待圖片載入
    function waitForImageLoad(img) {
      return new Promise((resolve, reject) => {
        if (img.complete) {
          resolve();
        } else {
          img.onload = resolve;
          img.onerror = reject;
          // 5秒超時
          setTimeout(() => reject(new Error('圖片載入超時')), 5000);
        }
      });
    }

    // 輔助函數：確保所有內容都已載入
    async function ensureContentLoaded() {
      // 等待字體載入
      if (document.fonts) {
        await document.fonts.ready;
      }
      
      // 等待圖片載入
      const images = document.querySelectorAll('#card img');
      const imagePromises = Array.from(images).map(img => {
        if (img.src && !img.complete) {
          return waitForImageLoad(img);
        }
        return Promise.resolve();
      });
      
      await Promise.all(imagePromises);
      
      // 額外等待以確保渲染完成
      await new Promise(resolve => setTimeout(resolve, 500));
    }

    // 頁面載入完成後初始化
    document.addEventListener('DOMContentLoaded', function() {
      updateCard();
      
      // 監聽表單變化自動更新預覽
      const inputs = ['name', 'description', 'address', 'date', 'time', 'host', 'contact', 'textColor'];
      inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updateCard);
          element.addEventListener('change', updateCard);
        }
      });
      
      // 監聽背景圖片變化
      const bgInput = document.getElementById('bgImage');
      if (bgInput) {
        bgInput.addEventListener('change', updateCard);
      }
    });

    // 處理頁面可見性變化時的重繪
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        setTimeout(updateCard, 100);
      }
    });
  </script>
</body>
</html>
